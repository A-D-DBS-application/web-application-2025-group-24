{% extends "base.html" %}

{% block lang %}nl{% endblock %}

{% block title %}Landowner Dashboard - GroundLink{% endblock %}

{% block body_class %}dashboard-page{% endblock %}

{% block header %}
<div class="dashboard-header">
    <div class="header-content">
        <h1>Landowner Dashboard</h1>
        <div class="nav">
            <a href="/">‚Üê Back to Home</a>
            <span id="headerUserInfo" style="display: none; color: white; font-weight: 500; margin-left: 15px;">Welcome, <span id="headerUserName"></span></span>
            <button id="headerLogoutBtn" onclick="logout()" style="display: none; margin-left: 15px; padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Logout</button>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container">
    <div class="login-section" id="loginSection" style="display: block;">
        <h2>Landowner Login</h2>
        <p>Enter your email address to manage your properties.</p>
        <br>
        <div style="max-width: 400px; margin: 0 auto;">
            <div class="form-group">
                <label for="propertyOwnerEmail">Email Address</label>
                <input type="email" id="propertyOwnerEmail" placeholder="owner@example.com">
            </div>
            <button class="btn" onclick="loginPropertyOwner()" style="width: 100%;">Login</button>
            <button class="btn btn-success" onclick="showRegisterPropertyOwner()" style="width: 100%; background: #27ae60; margin-top: 10px;">Create Account</button>
        </div>
    </div>

    <div class="register-section" id="registerPropertyOwnerSection" style="display: none;">
        <h2>Create Landowner Account</h2>
        <br>
        <div style="max-width: 400px; margin: 0 auto;">
            <div class="form-group">
                <label for="regOwnerFirstName">First Name</label>
                <input type="text" id="regOwnerFirstName" placeholder="First Name">
            </div>
            <div class="form-group">
                <label for="regOwnerLastName">Last Name</label>
                <input type="text" id="regOwnerLastName" placeholder="Last Name">
            </div>
            <div class="form-group">
                <label for="regOwnerEmail">Email Address</label>
                <input type="email" id="regOwnerEmail" placeholder="owner@example.com">
            </div>
            <div class="form-group">
                <label for="regOwnerPhone">Phone Number</label>
                <input type="tel" id="regOwnerPhone" placeholder="Phone Number">
            </div>
            <button class="btn" onclick="registerPropertyOwner()" style="width: 100%;">Create Account</button>
            <button class="btn btn-secondary" onclick="showLoginPropertyOwner()" style="width: 100%; margin-top: 10px;">Back to Login</button>
        </div>
    </div>

    <div id="ownerContent" style="display: none;">
    <div class="main-content">
        <div class="card">
            <h2>Add New Property</h2>
            
            <!-- Step 1: Property Details -->
            <div id="propertyStep1">
                <div style="display: flex; align-items: center; margin-bottom: 20px;">
                    <div style="background: #1a5f7a; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px;">1</div>
                    <span style="font-weight: 600; color: #1a5f7a;">Property Details</span>
                    <div style="flex: 1; height: 2px; background: #e9ecef; margin-left: 15px;"></div>
                    <div style="background: #e9ecef; color: #6c757d; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-left: 15px;">2</div>
                    <span style="font-weight: 600; color: #6c757d; margin-left: 10px;">Pricing</span>
                </div>
                
                <div class="form-group">
                    <label for="propertyType">Type</label>
                    <select id="propertyType" name="propertyType" required>
                        {% for type in property_types %}
                        <option value="{{ type.name.lower() }}" {% if loop.first %}selected{% endif %}>{{ type.value }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="propertyName">Property Name</label>
                    <input type="text" id="propertyName" name="propertyName" placeholder="e.g. Development Land Central, Agricultural Land East" required>
                </div>
                
                <div class="form-group">
                    <label for="province">Province</label>
                    <select id="province" name="province" required>
                        <option value="" disabled selected>Choose province</option>
                        {% for province in provinces %}
                        <option value="{{ province.value }}">{{ province.value }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="city">City</label>
                    <input type="text" id="city" name="city" placeholder="e.g. Gent" required>
                </div>
                
                <div class="form-group">
                    <label for="size">Area (m¬≤)</label>
                    <input type="number" id="size" name="size" placeholder="e.g. 1000" required>
                </div>
                
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3" placeholder="Describe your property..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="propertyImages">Property Images</label>
                    <input type="file" id="propertyImages" name="propertyImages" multiple accept="image/*" style="margin-bottom: 10px;">
                    <small style="color: #6c757d; font-size: 0.9em;">You can upload multiple images (JPG, PNG, GIF). Max 5MB per image.</small>
                    <div id="imagePreview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;"></div>
                </div>
                
                <button type="button" class="btn" onclick="confirmPropertyDetails()" style="width: 100%;">Confirm Details & Continue to Pricing ‚Üí</button>
            </div>
            
            <!-- Step 2: Pricing -->
            <div id="propertyStep2" style="display: none;">
                <div style="display: flex; align-items: center; margin-bottom: 20px;">
                    <div style="background: #28a745; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px;">‚úì</div>
                    <span style="font-weight: 600; color: #28a745;">Property Details</span>
                    <div style="flex: 1; height: 2px; background: #1a5f7a; margin-left: 15px;"></div>
                    <div style="background: #1a5f7a; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-left: 15px;">2</div>
                    <span style="font-weight: 600; color: #1a5f7a; margin-left: 10px;">Pricing</span>
                </div>
                
                <!-- Summary of confirmed details -->
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                    <h4 style="margin: 0 0 10px 0; color: #28a745;">‚úì Property Details Confirmed</h4>
                    <div id="confirmedDetailsSummary" style="color: #495057; font-size: 0.95em;"></div>
                </div>
                
                <!-- Proposed Price Box -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; padding: 20px; margin-bottom: 20px; color: white;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">Proposed Price</h4>
                    </div>
                    <div id="proposedPriceValue" style="font-size: 2em; font-weight: bold; margin: 10px 0;">
                        <span style="opacity: 0.7; font-size: 0.5em;">Coming soon...</span>
                    </div>
                    <p style="margin: 0; opacity: 0.85; font-size: 0.9em;">Based on location, size, and market data</p>
                </div>
                
                <!-- Price Input -->
                <form id="ownerForm">
                    <h4 style="margin-bottom: 15px; color: #1a5f7a;">Set Your Price Range</h4>
                    <div class="form-group">
                        <label for="priceMin">Minimum Price (‚Ç¨)</label>
                        <input type="number" id="priceMin" name="priceMin" placeholder="e.g. 100000" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="priceMax">Maximum Price (‚Ç¨)</label>
                        <input type="number" id="priceMax" name="priceMax" placeholder="e.g. 500000" min="0" required>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn" onclick="goBackToStep1()" style="background: #6c757d; flex: 1;">‚Üê Back to Edit Details</button>
                        <button type="submit" class="btn" style="flex: 2;">Add Property</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">My Properties</h2>
                <button onclick="toggleSoldProperties()" id="soldPropertiesBtn" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                    View Sold Properties
                </button>
            </div>
            <div id="myPropertiesList">
                <p style="text-align: center; color: #666;">Loading properties...</p>
            </div>
            
            <!-- Sold Properties Section (hidden by default) -->
            <div id="soldPropertiesSection" style="display: none; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                <h3 style="color: #28a745; margin-bottom: 15px;">Sold Properties</h3>
                <div id="soldPropertiesList">
                    <p style="text-align: center; color: #666;">No sold properties yet.</p>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{% block modals %}
{{ super() }}

<!-- Success Modal -->
<div id="successModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-icon">
            <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        </div>
        <h2 class="modal-title">Property Added Successfully!</h2>
        <p class="modal-message">Your property has been listed on GroundLink. Verified developers can now discover and express interest in your land.</p>
        <button class="modal-btn" onclick="closeSuccessModal()">Continue</button>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 450px;">
        <div id="confirmIcon" class="modal-icon" style="background: #fff3e0;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#ff9800" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        </div>
        <h2 id="confirmTitle" class="modal-title"></h2>
        <p id="confirmMessage" class="modal-message"></p>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button id="confirmCancelBtn" class="modal-btn" style="background: #6c757d; flex: 1;" onclick="closeConfirmModal(false)">Cancel</button>
            <button id="confirmOkBtn" class="modal-btn" style="background: #e74c3c; flex: 1;" onclick="closeConfirmModal(true)">Delete</button>
        </div>
    </div>
</div>

<!-- Developer Interest Modal -->
<div id="developerInterestModal" class="modal-overlay" onclick="if(event.target === this) closeDeveloperInterestModal()">
    <div class="modal-content" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #1976d2;">üéØ Interested Developers</h2>
            <button onclick="closeDeveloperInterestModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        <div id="developerInterestContent">
            <!-- Developer cards will be inserted here -->
        </div>
    </div>
</div>

<!-- Mark as Sold Modal -->
<div id="soldModal" class="modal-overlay" onclick="if(event.target === this) closeSoldModal()">
    <div class="modal-content" style="max-width: 450px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #28a745;">üí∞ Mark Property as Sold</h2>
            <button onclick="closeSoldModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        <p style="color: #666; margin-bottom: 20px;">Enter the final sale price. Once marked as sold, this property will no longer be visible to developers.</p>
        <div class="form-group">
            <label for="soldPrice" style="font-weight: 600;">Final Sale Price (‚Ç¨)</label>
            <input type="number" id="soldPrice" placeholder="Enter final price" min="0" step="0.01" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="closeSoldModal()" class="modal-btn" style="background: #6c757d; flex: 1;">Cancel</button>
            <button onclick="confirmSold()" class="modal-btn" style="background: #28a745; flex: 1;">Confirm Sale</button>
        </div>
    </div>
</div>

<!-- Edit Property Modal -->
<div id="editPropertyModal" class="modal-overlay" onclick="if(event.target === this) closeEditModal()">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #1a5f7a;">‚úèÔ∏è Edit Property</h2>
            <button onclick="closeEditModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        
        <input type="hidden" id="editPropertyId">
        
        <div class="form-group">
            <label for="editPropertyName">Property Name</label>
            <input type="text" id="editPropertyName" placeholder="Property name">
        </div>
        
        <div class="form-group">
            <label for="editPropertyType">Type</label>
            <select id="editPropertyType">
                {% for type in property_types %}
                <option value="{{ type.name.lower() }}">{{ type.value }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="editProvince">Province</label>
            <select id="editProvince">
                {% for province in provinces %}
                <option value="{{ province.value }}">{{ province.value }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="editCity">City</label>
            <input type="text" id="editCity" placeholder="City">
        </div>
        
        <div class="form-group">
            <label for="editSize">Area (m¬≤)</label>
            <input type="number" id="editSize" placeholder="Size in m¬≤" min="1">
        </div>
        
        <div class="form-group">
            <label for="editDescription">Description</label>
            <textarea id="editDescription" rows="3" placeholder="Property description"></textarea>
        </div>
        
        <div class="form-group">
            <label for="editPriceMin">Minimum Price (‚Ç¨)</label>
            <input type="number" id="editPriceMin" placeholder="Minimum price" min="0">
        </div>
        
        <div class="form-group">
            <label for="editPriceMax">Maximum Price (‚Ç¨)</label>
            <input type="number" id="editPriceMax" placeholder="Maximum price" min="0">
        </div>
        
        <div class="form-group">
            <label>Current Images</label>
            <div id="editCurrentImages" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;"></div>
        </div>
        
        <div class="form-group">
            <label for="editNewImages">Add New Images</label>
            <input type="file" id="editNewImages" multiple accept="image/*">
            <small style="color: #6c757d; font-size: 0.9em;">New images will be added to existing ones. Max 5MB per image.</small>
            <div id="editImagePreview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;"></div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="closeEditModal()" class="modal-btn" style="background: #6c757d; flex: 1;">Cancel</button>
            <button onclick="savePropertyChanges()" class="modal-btn" style="background: #1a5f7a; flex: 1;">Save Changes</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ===== Global Variables =====
    let propertiesData = []; // Store properties for modal access
    let confirmCallback = null;
    let selectedImages = [];
    
    // Show confirmation modal (replaces confirm)
    function showConfirm(title, message, onConfirm, options = {}) {
        const modal = document.getElementById('confirmModal');
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        
        // Customize buttons if options provided
        const okBtn = document.getElementById('confirmOkBtn');
        const cancelBtn = document.getElementById('confirmCancelBtn');
        okBtn.textContent = options.confirmText || 'Confirm';
        cancelBtn.textContent = options.cancelText || 'Cancel';
        okBtn.style.background = options.confirmColor || '#e74c3c';
        
        confirmCallback = onConfirm;
        modal.classList.add('active');
    }
    
    function closeConfirmModal(confirmed) {
        document.getElementById('confirmModal').classList.remove('active');
        if (confirmed && confirmCallback) {
            confirmCallback();
        }
        confirmCallback = null;
    }
    
    // Image preview functionality
    document.addEventListener('DOMContentLoaded', function() {
        const imageInput = document.getElementById('propertyImages');
        if (imageInput) {
            imageInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                const preview = document.getElementById('imagePreview');
                
                files.forEach((file, index) => {
                    if (file.type.startsWith('image/')) {
                        if (file.size > 5 * 1024 * 1024) {
                            showNotification('File Too Large', `Image ${file.name} is too large. Please choose images under 5MB.`, 'warning');
                            return;
                        }
                        
                        selectedImages.push(file);
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const container = document.createElement('div');
                            container.className = 'image-container';
                            container.innerHTML = `
                                <img src="${e.target.result}" class="image-preview" alt="Property preview">
                                <button type="button" class="remove-image" onclick="removeImage(${selectedImages.length - 1})">&times;</button>
                            `;
                            preview.appendChild(container);
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                e.target.value = '';
            });
        }
    });
    
    function removeImage(index) {
        selectedImages.splice(index, 1);
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '';
        
        selectedImages.forEach((file, newIndex) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const container = document.createElement('div');
                container.className = 'image-container';
                container.innerHTML = `
                    <img src="${e.target.result}" class="image-preview" alt="Property preview">
                    <button type="button" class="remove-image" onclick="removeImage(${newIndex})">&times;</button>
                `;
                preview.appendChild(container);
            };
            reader.readAsDataURL(file);
        });
    }
    
    // Check if user is already logged in
    function checkLoginStatus() {
        fetch('/api/current-user')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.user.user_type === 'property_owner') {
                showOwnerContent(data.user);
            }
        })
        .catch(() => {});
    }

    // Login function
    function loginPropertyOwner() {
        const propertyOwnerEmail = document.getElementById('propertyOwnerEmail').value.trim();
        
        if (!propertyOwnerEmail) {
            showNotification('Email Required', 'Please enter your email address.', 'warning');
            return;
        }

        fetch('/api/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: propertyOwnerEmail,
                user_type: 'property_owner'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showOwnerContent(data);
                loadMyProperties();
            } else {
                showNotification('Login Failed', data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Login error:', error);
            showNotification('Login Error', 'An error occurred while logging in. Please try again.', 'error');
        });
    }

    // Registration functions
    function showRegisterPropertyOwner() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('registerPropertyOwnerSection').style.display = 'block';
    }

    function showLoginPropertyOwner() {
        document.getElementById('registerPropertyOwnerSection').style.display = 'none';
        document.getElementById('loginSection').style.display = 'block';
    }

    function registerPropertyOwner() {
        const firstName = document.getElementById('regOwnerFirstName').value.trim();
        const lastName = document.getElementById('regOwnerLastName').value.trim();
        const email = document.getElementById('regOwnerEmail').value.trim();
        const phone = document.getElementById('regOwnerPhone').value.trim();
        
        if (!firstName || !lastName || !email || !phone) {
            showNotification('Missing Information', 'Please fill in all fields.', 'warning');
            return;
        }

        fetch('/api/register-property-owner', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                first_name: firstName,
                last_name: lastName,
                email: email,
                phone_number: phone
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Account Created', 'Your account has been created successfully! You can now log in.', 'success');
                showLoginPropertyOwner();
                document.getElementById('propertyOwnerEmail').value = email;
            } else {
                showNotification('Registration Failed', data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Registration error:', error);
            showNotification('Registration Error', 'An error occurred while creating your account. Please try again.', 'error');
        });
    }

    // Show owner content after login
    function showOwnerContent(userData) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('registerPropertyOwnerSection').style.display = 'none';
        document.getElementById('ownerContent').style.display = 'block';
        
        const firstName = userData.user_data.first_name || '';
        const lastName = userData.user_data.last_name || '';
        const userName = `${firstName} ${lastName}`.trim() || 'Owner';
        
        // Update header with user info
        document.getElementById('headerUserName').textContent = userName;
        document.getElementById('headerUserInfo').style.display = 'inline';
        document.getElementById('headerLogoutBtn').style.display = 'inline-block';
            
        loadMyProperties();
    }

    // Logout function
    function logout() {
        fetch('/api/logout', {
            method: 'POST'
        })
        .then(() => {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('ownerContent').style.display = 'none';
            document.getElementById('headerUserInfo').style.display = 'none';
            document.getElementById('headerLogoutBtn').style.display = 'none';
        });
    }

    // ===== Multi-Step Property Form =====
    let confirmedPropertyDetails = null;
    
    function confirmPropertyDetails() {
        // Validate step 1 fields
        const propertyType = document.getElementById('propertyType').value;
        const propertyName = document.getElementById('propertyName').value.trim();
        const province = document.getElementById('province').value;
        const city = document.getElementById('city').value.trim();
        const size = document.getElementById('size').value;
        const description = document.getElementById('description').value.trim();
        
        if (!propertyName || !province || !city || !size || !description) {
            showNotification('Missing Information', 'Please fill in all required fields before continuing.', 'warning');
            return;
        }
        
        // Validate if the city exists and is in the correct province
        fetch('/api/validate-city', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ city: city, province: province })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.valid) {
                showNotification('Invalid City', data.error || `'${city}' is not a recognized Belgian city. Please check the spelling.`, 'error');
                return;
            }
            
            // City is valid, continue with the form
            proceedWithPropertyDetails(propertyType, propertyName, province, city, size, description);
        })
        .catch(error => {
            console.error('Error validating city:', error);
            showNotification('Validation Error', 'Could not validate city. Please try again.', 'error');
        });
    }
    
    function proceedWithPropertyDetails(propertyType, propertyName, province, city, size, description) {
        // Store the confirmed details
        confirmedPropertyDetails = {
            type: propertyType,
            name: propertyName,
            province: province,
            city: city,
            size: size,
            description: description
        };
        
        // Update summary display
        document.getElementById('confirmedDetailsSummary').innerHTML = `
            <p style="margin: 5px 0;"><strong>Type:</strong> ${propertyType.charAt(0).toUpperCase() + propertyType.slice(1)}</p>
            <p style="margin: 5px 0;"><strong>Name:</strong> ${propertyName}</p>
            <p style="margin: 5px 0;"><strong>Location:</strong> ${city}, ${province}</p>
            <p style="margin: 5px 0;"><strong>Area:</strong> ${parseInt(size).toLocaleString('en-US')} m¬≤</p>
            <p style="margin: 5px 0;"><strong>Description:</strong> ${description.substring(0, 100)}${description.length > 100 ? '...' : ''}</p>
        `;
        
        // Hide step 1, show step 2
        document.getElementById('propertyStep1').style.display = 'none';
        document.getElementById('propertyStep2').style.display = 'block';
        
        // Show loading state for proposed price
        document.getElementById('proposedPriceValue').innerHTML = '<span style="opacity: 0.7;">Calculating...</span>';
        
        // Call the price estimation API
        fetch('/api/estimate-price', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                province: province,
                city: city,
                size: parseInt(size),
                type: propertyType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.suggested_price_min !== null && data.suggested_price_max !== null) {
                document.getElementById('proposedPriceValue').innerHTML = 
                    `‚Ç¨${data.suggested_price_min.toLocaleString('en-US')} - ‚Ç¨${data.suggested_price_max.toLocaleString('en-US')}`;
            } else {
                document.getElementById('proposedPriceValue').innerHTML = 
                    '<span style="opacity: 0.7; font-size: 0.5em;">Not enough data for estimation</span>';
            }
        })
        .catch(error => {
            console.error('Error estimating price:', error);
            document.getElementById('proposedPriceValue').innerHTML = 
                '<span style="opacity: 0.7; font-size: 0.5em;">Unable to estimate</span>';
        });
    }
    
    function goBackToStep1() {
        // Allow going back to edit details
        document.getElementById('propertyStep1').style.display = 'block';
        document.getElementById('propertyStep2').style.display = 'none';
        confirmedPropertyDetails = null;
    }
    
    function resetPropertyForm() {
        // Reset the form to step 1
        document.getElementById('propertyStep1').style.display = 'block';
        document.getElementById('propertyStep2').style.display = 'none';
        document.getElementById('propertyType').value = 'land';
        document.getElementById('propertyName').value = '';
        document.getElementById('province').value = '';
        document.getElementById('city').value = '';
        document.getElementById('size').value = '';
        document.getElementById('description').value = '';
        document.getElementById('priceMin').value = '';
        document.getElementById('priceMax').value = '';
        document.getElementById('imagePreview').innerHTML = '';
        selectedImages = [];
        confirmedPropertyDetails = null;
    }

    // Load user's properties
    function loadMyProperties() {
        fetch('/api/my-properties')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                propertiesData = data.properties; // Store for modal access
                displayMyProperties(data.properties);
            } else {
                document.getElementById('myPropertiesList').innerHTML = 
                    `<p style="text-align: center; color: red;">Error: ${data.error}</p>`;
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            document.getElementById('myPropertiesList').innerHTML = 
                '<p style="text-align: center; color: red;">Error loading properties.</p>';
        });
    }

    // Display user's properties (separated into active and sold)
    function displayMyProperties(properties) {
        const myPropertiesList = document.getElementById('myPropertiesList');
        const soldPropertiesList = document.getElementById('soldPropertiesList');
        
        // Separate active and sold properties
        const activeProperties = properties.filter(p => !p.sold);
        const soldProperties = properties.filter(p => p.sold);
        
        // Display active properties
        if (activeProperties.length === 0) {
            myPropertiesList.innerHTML = '<p style="text-align: center; color: #666;">You have no active properties.</p>';
        } else {
            myPropertiesList.innerHTML = activeProperties.map(property => renderPropertyCard(property, false)).join('');
        }
        
        // Display sold properties
        if (soldProperties.length === 0) {
            soldPropertiesList.innerHTML = '<p style="text-align: center; color: #666;">No sold properties yet.</p>';
        } else {
            soldPropertiesList.innerHTML = soldProperties.map(property => renderPropertyCard(property, true)).join('');
        }
        
        // Update sold properties button count
        const soldBtn = document.getElementById('soldPropertiesBtn');
        if (soldProperties.length > 0) {
            soldBtn.innerHTML = `View Sold Properties <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; margin-left: 5px;">${soldProperties.length}</span>`;
        } else {
            soldBtn.innerHTML = 'View Sold Properties';
        }
    }
    
    // Render a single property card
    function renderPropertyCard(property, isSold) {
        // Build image gallery HTML if there are images
        let imageGalleryHtml = '';
        if (property.image_urls && property.image_urls.length > 0) {
            imageGalleryHtml = `
                <div class="property-images-gallery" style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; overflow-x: auto; padding: 5px 0;">
                        ${property.image_urls.map((url, index) => `
                            <img src="${url}" 
                                 alt="Property image ${index + 1}" 
                                 style="width: 120px; height: 90px; object-fit: cover; border-radius: 6px; cursor: pointer; flex-shrink: 0; border: 2px solid #e9ecef;"
                                 onclick="openImageModal('${url}')"
                                 title="Click to enlarge">
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Count interested developers
        const interestCount = property.interested_developers ? property.interested_developers.length : 
                             (property.interested_developer ? 1 : 0);
        
        // Build developer interest section (only for active properties)
        let developerInterestHtml = '';
        if (!isSold) {
            if (interestCount > 0) {
                developerInterestHtml = `
                    <button onclick="showDeveloperInterest(${property.property_id})" 
                            style="background: #2196f3; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        Developer Interest 
                        <span style="background: #fff; color: #2196f3; padding: 2px 8px; border-radius: 12px; font-size: 0.85em;">${interestCount}</span>
                    </button>
                `;
            } else {
                developerInterestHtml = `
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; text-align: center; color: #6c757d; font-style: italic;">
                        No developer interest yet
                    </div>
                `;
            }
        }
        
        // Sold badge for sold properties
        const soldBadge = isSold ? 
            `<div style="background: #28a745; color: white; padding: 8px 12px; border-radius: 6px; text-align: center; font-weight: 600; margin-bottom: 12px;">
                ‚úì SOLD for ‚Ç¨${property.final_price ? property.final_price.toLocaleString('en-US') : '0'}
            </div>` : '';
        
        // Mark as sold button (only for active properties)
        const soldButton = isSold ? '' : `
            <button onclick="showSoldModal(${property.property_id})" 
                    style="background: #28a745; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                Mark as Sold
            </button>`;
        
        // Edit button (only for active properties)
        const editButton = isSold ? '' : `
            <button onclick="openEditModal(${property.property_id})" 
                    style="background: #1a5f7a; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                Edit Property
            </button>`;
        
        return `
            <div class="my-property-card">
                ${soldBadge}
                ${imageGalleryHtml}
                <p style="margin-bottom: 8px;"><strong>Province:</strong> ${property.province || 'Not specified'}</p>
                <p style="margin-bottom: 8px;"><strong>City:</strong> ${property.city || 'Not specified'}</p>
                <p style="margin-bottom: 8px;"><strong>Area:</strong> ${property.size} m¬≤</p>
                <p style="margin-bottom: 8px;"><strong>Type:</strong> ${property.type ? property.type.charAt(0).toUpperCase() + property.type.slice(1) : 'Land'}</p>
                <p style="margin-bottom: 8px; color: #27ae60;"><strong>Price:</strong> ‚Ç¨${property.price_min ? property.price_min.toLocaleString('en-US') : '0'} - ‚Ç¨${property.price_max ? property.price_max.toLocaleString('en-US') : '0'}</p>
                <p style="margin-bottom: 8px;"><strong>Description:</strong> ${property.description || 'No description'}</p>
                <p style="color: #6c757d; font-size: 0.9em; margin-bottom: 12px;"><strong>Added:</strong> ${new Date(property.created_at).toLocaleDateString('nl-BE')}</p>
                ${developerInterestHtml}
                ${editButton}
                ${soldButton}
                <button onclick="deleteProperty(${property.property_id})" 
                        style="background: #e74c3c; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    Delete Property
                </button>
            </div>
        `;
    }
    
    // Toggle sold properties section visibility
    function toggleSoldProperties() {
        const section = document.getElementById('soldPropertiesSection');
        const btn = document.getElementById('soldPropertiesBtn');
        
        if (section.style.display === 'none') {
            section.style.display = 'block';
            btn.style.background = '#28a745';
            btn.innerHTML = btn.innerHTML.replace('View', 'Hide');
        } else {
            section.style.display = 'none';
            btn.style.background = '#6c757d';
            btn.innerHTML = btn.innerHTML.replace('Hide', 'View');
        }
    }
    
    // Delete property function
    function deleteProperty(propertyId) {
        showConfirm(
            'Delete Property',
            'Are you sure you want to delete this property? This action cannot be undone and will also delete all associated images.',
            function() {
                fetch(`/api/delete-property/${propertyId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Property Deleted', 'Your property and all associated images have been deleted successfully.', 'success');
                        loadMyProperties();
                    } else {
                        showNotification('Delete Failed', data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                    showNotification('Delete Error', 'An error occurred while deleting the property.', 'error');
                });
            },
            { confirmText: 'Delete', confirmColor: '#e74c3c' }
        );
    }
    
    // Show developer interest modal
    function showDeveloperInterest(propertyId) {
        // Find the property in our stored data
        const property = propertiesData.find(p => p.property_id === propertyId);
        console.log('Property found:', property);
        console.log('interested_developers:', property?.interested_developers);
        
        if (!property) {
            console.error('Property not found in propertiesData');
            return;
        }
        
        const modalContent = document.getElementById('developerInterestContent');
        
        // Get all interested developers
        const developers = property.interested_developers || [];
        console.log('Developers to display:', developers);
        
        if (developers.length === 0) {
            modalContent.innerHTML = '<p style="text-align: center; color: #666;">No developer interest yet.</p>';
        } else {
            modalContent.innerHTML = developers.map(dev => `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; border-left: 4px solid #2196f3; margin-bottom: 10px;">
                    <p style="margin: 4px 0; color: #333;"><strong>Name:</strong> ${dev.first_name} ${dev.last_name}</p>
                    <p style="margin: 4px 0; color: #333;"><strong>Email:</strong> <a href="mailto:${dev.email}" style="color: #1976d2;">${dev.email}</a></p>
                    <p style="margin: 4px 0; color: #333;"><strong>Phone:</strong> ${dev.phone_number ? `<a href="tel:${dev.phone_number}" style="color: #1976d2;">${dev.phone_number}</a>` : 'Not provided'}</p>
                    ${dev.company ? `<p style="margin: 4px 0; color: #333;"><strong>Company:</strong> ${dev.company}</p>` : ''}
                    <p style="margin: 8px 0 0 0; font-size: 0.85em; color: #666;">This developer has viewed your contact information and is interested in your property.</p>
                </div>
            `).join('');
        }
        
        document.getElementById('developerInterestModal').classList.add('active');
    }
    
    // Close developer interest modal
    function closeDeveloperInterestModal() {
        document.getElementById('developerInterestModal').classList.remove('active');
    }

    // ===== Mark as Sold Functions =====
    let soldPropertyId = null;
    
    function showSoldModal(propertyId) {
        soldPropertyId = propertyId;
        document.getElementById('soldPrice').value = '';
        document.getElementById('soldModal').classList.add('active');
    }
    
    function closeSoldModal() {
        document.getElementById('soldModal').classList.remove('active');
        soldPropertyId = null;
    }
    
    function confirmSold() {
        const priceInput = document.getElementById('soldPrice').value;
        const price = parseFloat(priceInput);
        
        console.log('confirmSold called, propertyId:', soldPropertyId, 'price:', price);
        
        if (!priceInput || isNaN(price) || price <= 0) {
            showNotification('Invalid Price', 'Please enter a valid sale price.', 'warning');
            return;
        }
        
        fetch(`/api/mark-sold/${soldPropertyId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ definite_price: price })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Mark sold response:', data);
            if (data.success) {
                closeSoldModal();
                showNotification('Property Sold', 'Property has been marked as sold successfully!', 'success');
                loadMyProperties();
            } else {
                showNotification('Error', data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error marking as sold:', error);
            showNotification('Error', 'An error occurred while marking the property as sold.', 'error');
        });
    }

    // Form submission for adding properties
    document.getElementById('ownerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('Form submitted!');
        
        fetch('/api/current-user')
        .then(response => response.json())
        .then(userData => {
            console.log('Current user check:', userData);
            
            if (!userData.success || userData.user.user_type !== 'property_owner') {
                showNotification('Login Required', 'You must be logged in as a property owner to add properties.', 'warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('property_name', document.getElementById('propertyName').value);
            formData.append('province', document.getElementById('province').value);
            formData.append('city', document.getElementById('city').value);
            formData.append('size', document.getElementById('size').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('type', document.getElementById('propertyType').value);
            formData.append('price_min', document.getElementById('priceMin').value);
            formData.append('price_max', document.getElementById('priceMax').value);
            
            selectedImages.forEach((image, index) => {
                formData.append(`image_${index}`, image);
            });
            formData.append('image_count', selectedImages.length);
            
            console.log('Submitting with', selectedImages.length, 'images');
            
            fetch('/api/submit-property', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    showSuccessModal();
                    document.getElementById('ownerForm').reset();
                    resetPropertyForm();
                    loadMyProperties();
                } else {
                    showNotification('Submission Failed', data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Submission Error', 'An error occurred while adding your property. Please try again.', 'error');
            });
        })
        .catch(error => {
            console.error('Error checking login status:', error);
            showNotification('Session Error', 'An error occurred while checking your login status.', 'error');
        });
    });

    // Load properties when page loads
    document.addEventListener('DOMContentLoaded', function() {
        checkLoginStatus();
    });

    // Success Modal functions
    function showSuccessModal() {
        document.getElementById('successModal').classList.add('active');
    }

    function closeSuccessModal() {
        document.getElementById('successModal').classList.remove('active');
    }
    
    // ===== Edit Property Functions =====
    let editSelectedImages = [];
    let editCurrentImageUrls = [];
    let imagesToDelete = [];
    
    function openEditModal(propertyId) {
        const property = propertiesData.find(p => p.property_id === propertyId);
        if (!property) {
            showNotification('Error', 'Property not found', 'error');
            return;
        }
        
        // Reset state
        editSelectedImages = [];
        imagesToDelete = [];
        editCurrentImageUrls = property.image_urls || [];
        
        // Populate form fields
        document.getElementById('editPropertyId').value = property.property_id;
        document.getElementById('editPropertyName').value = property.property_name || '';
        document.getElementById('editPropertyType').value = property.type || 'land';
        document.getElementById('editProvince').value = property.province || '';
        document.getElementById('editCity').value = property.city || '';
        document.getElementById('editSize').value = property.size || '';
        document.getElementById('editDescription').value = property.description || '';
        document.getElementById('editPriceMin').value = property.price_min || '';
        document.getElementById('editPriceMax').value = property.price_max || '';
        
        // Display current images
        renderCurrentImages();
        
        // Clear new image preview
        document.getElementById('editImagePreview').innerHTML = '';
        document.getElementById('editNewImages').value = '';
        
        // Show modal
        document.getElementById('editPropertyModal').classList.add('active');
    }
    
    function renderCurrentImages() {
        const container = document.getElementById('editCurrentImages');
        if (editCurrentImageUrls.length === 0) {
            container.innerHTML = '<p style="color: #666;">No images</p>';
            return;
        }
        
        container.innerHTML = editCurrentImageUrls.map((url, index) => `
            <div style="position: relative; display: inline-block;">
                <img src="${url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: ${imagesToDelete.includes(url) ? '3px solid #e74c3c' : '1px solid #ddd'};">
                <button onclick="toggleImageDelete('${url}')" 
                        style="position: absolute; top: -8px; right: -8px; background: ${imagesToDelete.includes(url) ? '#28a745' : '#e74c3c'}; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;">
                    ${imagesToDelete.includes(url) ? '‚Ü©' : '√ó'}
                </button>
            </div>
        `).join('');
    }
    
    function toggleImageDelete(url) {
        const index = imagesToDelete.indexOf(url);
        if (index > -1) {
            imagesToDelete.splice(index, 1);
        } else {
            imagesToDelete.push(url);
        }
        renderCurrentImages();
    }
    
    function closeEditModal() {
        document.getElementById('editPropertyModal').classList.remove('active');
        editSelectedImages = [];
        imagesToDelete = [];
    }
    
    // Handle new image selection for edit
    document.addEventListener('DOMContentLoaded', function() {
        const editImageInput = document.getElementById('editNewImages');
        if (editImageInput) {
            editImageInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                const preview = document.getElementById('editImagePreview');
                
                files.forEach((file) => {
                    if (file.type.startsWith('image/')) {
                        if (file.size > 5 * 1024 * 1024) {
                            showNotification('File Too Large', `Image ${file.name} is too large. Max 5MB.`, 'warning');
                            return;
                        }
                        
                        editSelectedImages.push(file);
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const container = document.createElement('div');
                            container.style.cssText = 'position: relative; display: inline-block;';
                            container.innerHTML = `
                                <img src="${e.target.result}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #28a745;">
                                <span style="position: absolute; bottom: 2px; left: 2px; background: #28a745; color: white; font-size: 10px; padding: 2px 4px; border-radius: 3px;">NEW</span>
                            `;
                            preview.appendChild(container);
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                e.target.value = '';
            });
        }
    });
    
    async function savePropertyChanges() {
        const propertyId = document.getElementById('editPropertyId').value;
        const propertyName = document.getElementById('editPropertyName').value.trim();
        const propertyType = document.getElementById('editPropertyType').value;
        const province = document.getElementById('editProvince').value;
        const city = document.getElementById('editCity').value.trim();
        const size = document.getElementById('editSize').value;
        const description = document.getElementById('editDescription').value.trim();
        const priceMin = document.getElementById('editPriceMin').value;
        const priceMax = document.getElementById('editPriceMax').value;
        
        // Validate required fields
        if (!propertyName || !city || !size || !priceMin || !priceMax) {
            showNotification('Missing Information', 'Please fill in all required fields.', 'warning');
            return;
        }
        
        // Validate city and province
        try {
            const validateResponse = await fetch('/api/validate-city', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ city: city, province: province })
            });
            const validateData = await validateResponse.json();
            
            if (!validateData.valid) {
                showNotification('Invalid City', validateData.error, 'error');
                return;
            }
        } catch (error) {
            console.error('City validation error:', error);
            showNotification('Validation Error', 'Could not validate city.', 'error');
            return;
        }
        
        // Build form data
        const formData = new FormData();
        formData.append('property_name', propertyName);
        formData.append('type', propertyType);
        formData.append('province', province);
        formData.append('city', city);
        formData.append('size', size);
        formData.append('description', description);
        formData.append('price_min', priceMin);
        formData.append('price_max', priceMax);
        formData.append('images_to_delete', JSON.stringify(imagesToDelete));
        
        // Add new images
        editSelectedImages.forEach((file, index) => {
            formData.append(`new_image_${index}`, file);
        });
        
        try {
            const response = await fetch(`/api/update-property/${propertyId}`, {
                method: 'PUT',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Success', 'Property updated successfully!', 'success');
                closeEditModal();
                loadMyProperties();
            } else {
                showNotification('Update Failed', data.error || 'Could not update property.', 'error');
            }
        } catch (error) {
            console.error('Update error:', error);
            showNotification('Update Error', 'An error occurred while updating the property.', 'error');
        }
    }
</script>
{% endblock %}
